{#if transition}
  <tr class="transible {checked ? 'is-selected' : ''}" transition:fly="{x:20, delay:(25*row_index)}" on:click="rowClick(this)">
    {#if bulk_actions}
      <td style="vertical-align:middle;" class="{checked ? 'has-background-primary' : ''}">
        <Checkbox
          size="medium"
          color="white"
          style="margin:0;"
          inverted={true}
          bind:checked
          on:change="changed()"
        />
      </td>
    {/if}
    {#each column_keys as column}
      {#if isVisible(column)}
        <CellHOC
          target={resolveComponent(column, row)}
          on:*="fire('_forwardEvent', event)"
          {column}
          {row}
          {transforms}
          {classNames}
          {styles}
        />
      {/if}
    {/each}
  </tr>
{:else}
  <tr on:click="rowClick(this)">
    {#if bulk_actions}
      <td style="vertical-align:middle;">
        <Checkbox
          size="medium"
          color="white"
          style="margin:0;"
          inverted={false}
          bind:checked
          on:change="changed()"
        />
      </td>
    {/if}
    {#each column_keys as column}
      {#if isVisible(column)}
        <CellHOC
          target={resolveComponent(column, row)}
          on:*="fire('_forwardEvent', event)"
          {column}
          {row}
          {transforms}
          {classNames}
          {styles}
        />
      {/if}
    {/each}
  </tr>
{/if}

<script>
  import { fly } from 'svelte-transitions';
  import GridCell from './GridCell.html';
  import {createHOC} from '@kws3/helpers';
  import {Checkbox} from '@kws3/controls';

  export default {
    components:{
      CellHOC: createHOC(),
      Checkbox
    },
    transitions:{fly},
    data(){
      return {
        row_index:0,
        row:{},
        isVisible:{},
        clickableRows: false,
        transforms:{},
        classNames:{},
        styles:{},
        column_keys:[],
        cellComponent:{},
        checked: false,
        selectedIds: []
      }
    },
    computed:{
      resolveComponent({cellComponent}){
        return function(column, row){
          return cellComponent(column, row) || GridCell;
        }
      }
    },
    oncreate(){
      this.on('_forwardEvent', (e) => {
        this.fire(e.name, e.event);
      });

      this.on('state', ({changed, current}) => {
        if(changed.selectedIds){
          let {row} = this.get();
          let checked = false;
          if(current.selectedIds.indexOf(row.id) != -1){
            checked = true;
          }
          this.set({checked});
        }
      })
    },
    methods:{
      rowClick(el){
        let {clickableRows, row} = this.get();
        if(clickableRows){
          el && el.classList.add('is-selected');
          this.fire('rowClick', {comp: this, row});
        }
      },
      changed(){
        this.fire('selectCheckbox', this);
      }
    }
  }

</script>