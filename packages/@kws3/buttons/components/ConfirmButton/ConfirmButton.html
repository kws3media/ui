<div class="field {confirm ? 'has-addons' : ''} {classes}">
  <p class="control">
    {#if confirm}
      <button class="button is-success is-outlined is-shadowless is-{size}" type="button" on:click="cancel(event)"> Cancel </button>
    {/if}
  </p>
  <p class="control is-expanded">
    <button class="button is-{size} {doing ? main_color + ' is-loading' : (error ? 'is-danger is-shaking' : (done ? main_color : (confirm ? 'is-outlined ' + main_color : main_color)))}" type="button" on:click="doit(event)" disabled="{done || doing || error || disabled}">
      {#if done}
        <Icon size="{icon_size}" icon="{done_icon}"/>{#if !icon_only} <span>{done_text}</span>{/if}
      {:elseif doing}
       <Icon size="{icon_size}" icon="{doing_icon}"/>{#if !icon_only} <span>{doing_text}</span>{/if}
      {:elseif confirm}
        <span>{#if !icon_only}Are you sure{:else}Sure{/if}</span> <Icon size="{icon_size}" icon="question" />
      {:elseif error}
        <Icon size="{icon_size}" icon="exclamation"/> <span>Failed</span>
      {:elseif !confirm && !doing && !done && !error}
        <Icon size="{icon_size}" icon="{icon}" />{#if !icon_only} <span>{text}</span>{/if}
      {/if}
    </button>
  </p>
</div>

<script>
  import { Icon } from '@kws3/helpers';

  export default {
    components: { Icon },
    data: function(){
      return {
        classes: '',
        text: '',
        size:'',
        icon: 'check',
        color: 'info',
        doing_icon: 'hourglass',
        doing_text: 'Please Wait...',
        done_icon: 'check',
        done_text: 'Done',
        confirm: false,
        doing: false,
        done: false,
        error: false,
        context:null,
        icon_only: false,
        disabled: false
      }
    },
    computed:{
      main_color({ color }){
        return 'is-' + color;
      },
      icon_size({ size }){
        switch(size){
          case 'large':
            return '';
          break;
          default:
            return 'small';
          break;
        }
      }
    },
    onstate({ changed, current, previous }) {
      if (changed.type) {
        this.set({ color: current.type })
      }
    },
    methods:{
      cancel: function(e){
        e && e.preventDefault();
        this.set({confirm:false});
      },
      doit: function(e){
        e && e.preventDefault();
        var self = this,
        _confirm = self.get().confirm;
        if(!_confirm){
          self.set({confirm:true});
          return;
        }
        if(_confirm){
          self.fire('do', self);
        }
      },
      doing: function(){
        var self = this;
        self.set({
          confirm: false,
          doing: true,
          done: false,
          error: false
        });
      },
      done: function(){
        var self = this;
        self.set({
          doing: false,
          done: true,
          error: false
        });

        setTimeout(function(){
          self.set({done:false});
          self.fire('done');
        }, 1500)
      },
      error: function(){
        var self = this;
        self.set({
          done: false,
          doing: false,
          error: true
        });

        setTimeout(function(){
          self.set({error:false});
          self.fire('error');
        }, 1500)

      }
    }
  }
</script>