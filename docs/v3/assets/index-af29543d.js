class o{constructor(){this.commands=[],this.index=-1,this.isExecuting=!1,this.callback=null}execute(t,s){return!t||typeof t[s]!="function"?this:(this.isExecuting=!0,t[s](),this.isExecuting=!1,this)}add(t){return this.isExecuting?this:(this.commands.splice(this.index+1,this.commands.length-this.index),this.commands.push(t),this.index=this.commands.length-1,this.callback&&this.callback(),this)}setCallback(t){this.callback=t}undo(){const t=this.commands[this.index];return t?(this.execute(t,"undo"),this.index-=1,this.callback&&this.callback(),this):this}redo(){const t=this.commands[this.index+1];return t?(this.execute(t,"redo"),this.index+=1,this.callback&&this.callback(),this):this}clear(){const t=this.commands.length;this.commands=[],this.index=-1,this.callback&&t>0&&this.callback()}hasUndo(){return this.index!==-1}hasRedo(){return this.index<this.commands.length-1}getCommands(){return this.commands}}var h=!1;try{let e=Object.defineProperty({},"passive",{get:()=>h=!0});typeof window<"u"&&window.addEventListener("test",null,e)}catch(e){console.log(e)}var n=h?{passive:!1,capture:!1}:!1;class r{constructor(t,s){this.app=t,this.canvas=this.app.CANVAS,this.context=this.canvas.getContext("2d"),this.drawing=!1,this.currentPos={x:0,y:0},this.lastPos=this.currentPos,this.scaleFactor=s.initialScale,this.drawingType="Pen",this.penColor=s.penColor,this.penWidth=s.penWidth,this.eraserWidth=s.eraserWidth,this.readonly=s.readonly,this.image=s.image,this.tools=s.tools,s.expanded&&(this.scaleFactor=s.expand),this.undoManager=new o,this.prevState=null,this.START=this.start.bind(this),this.MOVE=this.move.bind(this),this.END=this.end.bind(this),this.RENDER=this.render.bind(this)}prevent(t){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation()}getPosition(t){let s,i,a=this.canvas.getBoundingClientRect();return t.type.indexOf("touch")!==-1?(s=t.touches[0].clientX-a.left,i=t.touches[0].clientY-a.top):(s=t.clientX-a.left,i=t.clientY-a.top),{x:s/this.scaleFactor,y:i/this.scaleFactor}}render(){this.draw(),this.drawing&&typeof window<"u"&&window.setTimeout(()=>this.render(),1e3/60)}draw(){this.drawing&&(this.context.strokeStyle=this.penColor,this.context.lineWidth=this.penWidth,this.drawingType==="Eraser"&&(this.context.lineWidth=this.eraserWidth),this.tools[this.drawingType].draw(this))}move(t){this.prevent(t),this.currentPos=this.getPosition(t)}end(t){this.prevent(t),this.drawing=!1,this.addHistory(),document.removeEventListener("touchmove",this.MOVE),document.removeEventListener("mousemove",this.MOVE),document.removeEventListener("touchend",this.END),document.removeEventListener("mouseup",this.END),this.fire("change")}start(t){this.prevent(t),this.drawing=!0,this.currentPos=this.getPosition(t),this.lastPos=this.currentPos,document.addEventListener("touchmove",this.MOVE,n),document.addEventListener("mousemove",this.MOVE,n),document.addEventListener("touchend",this.END,n),document.addEventListener("mouseup",this.END,n),this.prevState=this.getImageData(),this.render()}addHistory(){let t=this.getImageData(),s=this.prevState;this.undoManager.add({undo:()=>{this.setImageData(s.data)},redo:()=>{this.setImageData(t.data)}})}resetHistory(){this.undoManager.clear()}getImageData(){return this.context.getImageData(0,0,this.canvas.width,this.canvas.height)}setImageData(t){let s=this.getImageData();for(let i=0;i<s.data.length;i++)s.data[i]=t[i];this.context.putImageData(s,0,0)}setImage(t,s){if(t){let i=new Image;i.src=t,i.onload=()=>{this.context.drawImage(i,0,0,i.width,i.height,0,0,this.canvas.width,this.canvas.height),s&&s(),this.fire("change")}}}fire(t){switch(t){case"change":this.app.fire("change",{canUndo:this.canUndo(),canRedo:this.canRedo(),canvasImage:this.canvas.toDataURL()});break}}canUndo(){return this.undoManager.hasUndo()}canRedo(){return this.undoManager.hasRedo()}init(){this.is_readonly=this.readonly||!1,this.imageDataUrl=this.image||"",this.resetHistory(),this.setImage(this.imageDataUrl),this.addEvent()}syncImage(t){this.canvas.toDataURL()!==t&&(this.prevState=this.getImageData(),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.setImage(t,()=>{this.addHistory()}))}addEvent(){this.is_readonly||(this.canvas.addEventListener("touchstart",this.START,!1),this.canvas.addEventListener("mousedown",this.START,!1))}removeEvent(){this.canvas.removeEventListener("touchstart",this.START),this.canvas.removeEventListener("mousedown",this.START)}undo(){this.canUndo()&&(this.undoManager.undo(),this.fire("change"))}redo(){this.canRedo()&&(this.undoManager.redo(),this.fire("change"))}reset(){this.prevState=this.getImageData(),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.addHistory(),this.fire("change")}setScaleFactor(t){this.scaleFactor=t}setTool(t){this.drawingType=t}setColor(t){this.penColor=t}}let d={name:"Pen",icon:"pencil",draw:e=>{e.context.beginPath(),e.context.moveTo(e.lastPos.x,e.lastPos.y),e.context.lineCap="round",e.context.lineTo(e.currentPos.x,e.currentPos.y),e.context.stroke(),e.context.globalCompositeOperation="source-over",e.lastPos=e.currentPos}},c={name:"Eraser",icon:"eraser",draw:e=>{e.context.beginPath(),e.context.moveTo(e.lastPos.x,e.lastPos.y),e.context.lineTo(e.currentPos.x,e.currentPos.y),e.context.stroke(),e.context.globalCompositeOperation="destination-out",e.lastPos=e.currentPos}};function l(e){return e.keyCode&&e.keyCode===13}function u(e){return e.keyCode&&e.keyCode===27}const g=typeof window<"u"&&"navigator"in window?/mac/i.test(window.navigator.userAgentData?window.navigator.userAgentData.platform:window.navigator.platform):!1;export{r as D,c as E,g as I,d as P,l as a,u as i};
